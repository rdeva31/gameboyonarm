@-------------------------------------------------------------------------------
@ External Variables
@-------------------------------------------------------------------------------

	.extern RAM


@@@@@@@@@@@@@
	.text
	.align 2
	.code 32
@@@@@@@@@@@@@

@-------------------------------------------------------------------------------
@ Macro Definitions
@-------------------------------------------------------------------------------

.macro SET_A r
	bic r0, r0, r11, lsl #8
	orr r0, r0, \r, lsl #8
.endm

.macro SET_B r
	bic r0, r0, r11, lsl #24
	orr r0, r0, \r, lsl #24
.endm

.macro SET_C r
	bic r0, r0, r11, lsl #16
	orr r0, r0, \r, lsl #16
.endm

.macro SET_F r
	bic r0, r0, r11
	orr r0, r0, \r
.endm

.macro SET_FLAG_Z
	orr r0, r0, #0x80
.endm

.macro SET_FLAG_N
	orr r0, r0, #0x40
.endm

.macro SET_FLAG_H
	orr r0, r0, #0x20
.endm

.macro SET_FLAG_C
	orr r0, r0, #0x10
.endm

.macro RESET_FLAG_Z
	bic r0, r0, #0x80
.endm

.macro RESET_FLAG_N
	bic r0, r0, #0x40
.endm

.macro RESET_FLAG_H
	bic r0, r0, #0x20
.endm

.macro RESET_FLAG_C
	bic r0, r0, #0x10
.endm

.macro UPDATE_FLAG_Z
	orrne r0, r0, #0x80
	biceq r0, r0, #0x80
.endm

.macro UPDATE_FLAG_H r, m
	tst \r, \m
	orrne r0, r0, #0x20
	biceq r0, r0, #0x20
.endm

.macro UPDATE_FLAG_C r, m
	tst \r, \m
	orrne r0, r0, #0x10
	biceq r0, r0, #0x10
.endm

.macro SET_D r
	bic r1, r1, r11, lsl #24
	orr r1, r1, \r, lsl #24
.endm

.macro SET_E r
	bic r1, r1, r11, lsl #16
	orr r1, r1, \r, lsl #16
.endm

.macro SET_H r
	bic r1, r1, r11, lsl #8
	orr r1, r1, \r, lsl #8
.endm

.macro SET_L r
	bic r1, r1, r11
	orr r1, r1, \r
.endm

.macro SET_AF r
	bic r0, r0, r12
	orr r0, r0, \r
.endm

.macro SET_BC r
	bic r0, r0, r12, lsl #16
	orr r0, r0, \r, lsl #16
.endm

.macro SET_DE r
	bic r1, r1, r12, lsl #16
	orr r1, r1, \r, lsl #16
.endm

.macro SET_HL r
	bic r1, r1, r12
	orr r1, r1, \r
.endm

.macro SET_SP r
	mov r2, \r
.endm

.macro READ_A r
	mov \r, r0, lsr #8
	and \r, \r, #0xFF
.endm

.macro READ_F r
	and \r, r0, #0xFF
.endm

.macro READ_B r
	mov \r, r0, lsr #24
.endm

.macro READ_C r
	mov \r, r0, lsr #16
	and \r, \r, #0xFF
.endm

.macro READ_D r
	mov \r, r1, lsr #24
.endm

.macro READ_E r
	mov \r, r1, lsr #16
	and \r, \r, #0xFF
.endm

.macro READ_H r
	mov \r, r1, lsr #8
	and \r, \r, #0xFF
.endm

.macro READ_L r
	and \r, r1, #0xFF
.endm

.macro READ_AF r
	and \r, r0, r12
.endm

.macro READ_BC r
	mov \r, r0, lsr #16
.endm

.macro READ_DE r
	mov \r, r1, lsr #16
.endm

.macro READ_HL r
	and \r, r1, r12
.endm

.macro READ_SP r
	mov \r, r2
.endm

.macro WRITE_8 r, a
	strb \r, [r5, \a]
.endm

.macro WRITE_16 r, a
	strb \r, [r5, \a]
	add \a, \a, #1
	lsr \r, \r, #8
	strb \r, [r5, \a]
.endm

.macro READ_8 r, a
	ldrb \r, [r5, \a]
.endm

.macro READ_16 r, a, t
	ldrb \r, [r5, \a]
	add \a, \a, #1
	ldrb \t, [r5, \a]
	sub \a, \a, #1
	orr \r, \r, \t, lsl #8
.endm

.macro READ_IMM8 r
	ldrb \r, [r5, r3]
	add r3, r3, #1
.endm

.macro READ_IMM16 r, t
	ldrb \r, [r5, r3]
	add r3, r3, #1
	ldrb \t, [r5, r3]
	add r3, r3, #1
	orr \r, \r, \t, lsl #8
.endm

.macro UPDATE_CYCLE_COUNT c
	add r4, r4, #\c
.endm

.macro SIGN_EXTEND_8TO9 r
	tst \r, #0x10000
	orreq \r, \r, r9, lsl #8
.endm

.macro SIGN_EXTEND_8TO17 r
	tst \r, #0x100
	orreq \r, \r, r11, lsl #8
	orreq \r, \r, r9, lsl #16
.endm

@-------------------------------------------------------------------------------
@ void executeFrame (void)
@-------------------------------------------------------------------------------
@ r0  = B,C,A,F State Registers
@ r1  = D,E,H,L State Registers
@ r2  = SP State Register
@ r3  = PC State Register
@ r4  = Frame Cycle Count
@ r5  = RAM Address
@ r11 = Byte mask (0xFF)
@ r12 = Word mask (0xFFFF)
@-------------------------------------------------------------------------------
executeFrame:
	.global executeFrame

	push {r4,r5,r6,r7,r8,r9,r10,r11,r12,lr}		@ Saving registers for calling function

	ldr r7, =State
	ldr r0, [r7]					@ Loading A,B,C,F
	ldr r1, [r7, #4]				@ Loading D,E,H,L
	ldr r2, [r7, #8]				@ Loading SP
	ldr r3, [r7, #12]				@ Loading PC
	ldr r4, [r7, #16]				@ Loading frame cycle count

	ldr r5, =RAM					@ Initializing r5 to the RAM address

	mov r11, #0xFF					@ Initializing r11 to 0xFF used for byte masking
	orr r12, r11, r11, lsl #8		@ Initializing r12 to 0xFFFF used for word masking

.next:

	ldrb r6, [r5, r3]				@ Loading the next instruction opcode
	add r3, r3, #1					@ Incrementing PC by 1

	ldr r7, =OpcodeJT				@ Loading opcode jump table address
	ldr r7, [r7, r6]				@ Loading opcode handler function address

	adr lr, .opReturn				@ Loading link register with the return address
	bx r7							@ Branching to the opcode handler function

.opReturn:

	ldr r7, =17555
	subs r6, r4, r7					@ Calculating leftover cycle count
	blo .next						@  and continue to next instruction if < max

.done:

	ldr r7, =State
	str r0, [r7]					@ Saving A,F,B,C
	str r1, [r7, #4]				@ Saving D,E,H,L
	str r2, [r7, #8]				@ Saving SP
	str r3, [r7, #12]				@ Saving PC
	str r6, [r7, #16]				@ Saving leftover cycle count

	pop	{r4,r5,r6,r7,r8,r9,r10,r11,r12,lr}		@ Restoring registers for calling function

	bx lr

@-------------------------------------------------------------------------------
@ Not Implemented
@-------------------------------------------------------------------------------
op__:

	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ NOP
@-------------------------------------------------------------------------------
op00:

	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD B, ##
@-------------------------------------------------------------------------------
op06:
	
	READ_IMM8 r6
	SET_B r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD C, ##
@-------------------------------------------------------------------------------
op0E:
	
	READ_IMM8 r6
	SET_C r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD D, ##
@-------------------------------------------------------------------------------
op16:
	
	READ_IMM8 r6
	SET_D r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD E, ##
@-------------------------------------------------------------------------------
op1E:
	
	READ_IMM8 r6
	SET_E r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD H, ##
@-------------------------------------------------------------------------------
op26:
	
	READ_IMM8 r6
	SET_H r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD L, ##
@-------------------------------------------------------------------------------
op2E:

	READ_IMM8 r6
	SET_L r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD A, A
@-------------------------------------------------------------------------------
op7F:

	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD A, B
@-------------------------------------------------------------------------------
op78:

	READ_B r6
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD A, C
@-------------------------------------------------------------------------------
op79:

	READ_C r6
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD A, D
@-------------------------------------------------------------------------------
op7A:

	READ_D r6
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD A, E
@-------------------------------------------------------------------------------
op7B:

	READ_E r6
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD A, H
@-------------------------------------------------------------------------------
op7C:

	READ_H r6
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD A, L
@-------------------------------------------------------------------------------
op7D:

	READ_L r6
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD A, (HL)
@-------------------------------------------------------------------------------
op7E:

	READ_HL r7
	READ_8 r6, r7
	SET_A r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD B, B
@-------------------------------------------------------------------------------
op40:

	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD B, C
@-------------------------------------------------------------------------------
op41:

	READ_C r6
	SET_B r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD B, D
@-------------------------------------------------------------------------------
op42:

	READ_D r6
	SET_B r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD B, E
@-------------------------------------------------------------------------------
op43:

	READ_E r6
	SET_B r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD B, H
@-------------------------------------------------------------------------------
op44:

	READ_H r6
	SET_B r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD B, L
@-------------------------------------------------------------------------------
op45:

	READ_L r6
	SET_B r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD B, (HL)
@-------------------------------------------------------------------------------
op46:

	READ_HL r7
	READ_8 r6, r7
	SET_B r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD C, B
@-------------------------------------------------------------------------------
op48:

	READ_B r6
	SET_C r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD C, C
@-------------------------------------------------------------------------------
op49:

	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD C, D
@-------------------------------------------------------------------------------
op4A:

	READ_D r6
	SET_C r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD C, E
@-------------------------------------------------------------------------------
op4B:

	READ_E r6
	SET_C r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD C, H
@-------------------------------------------------------------------------------
op4C:

	READ_H r6
	SET_C r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD C, L
@-------------------------------------------------------------------------------
op4D:

	READ_L r6
	SET_C r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD C, (HL)
@-------------------------------------------------------------------------------
op4E:

	READ_HL r7
	READ_8 r6, r7
	SET_C r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD D, B
@-------------------------------------------------------------------------------
op50:

	READ_B r6
	SET_D r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD D, C
@-------------------------------------------------------------------------------
op51:

	READ_C r6
	SET_D r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD D, D
@-------------------------------------------------------------------------------
op52:

	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD D, E
@-------------------------------------------------------------------------------
op53:

	READ_E r6
	SET_D r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD D, H
@-------------------------------------------------------------------------------
op54:

	READ_H r6
	SET_D r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD D, L
@-------------------------------------------------------------------------------
op55:

	READ_L r6
	SET_D r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD D, (HL)
@-------------------------------------------------------------------------------
op56:

	READ_HL r7
	READ_8 r6, r7
	SET_D r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD E, B
@-------------------------------------------------------------------------------
op58:

	READ_B r6
	SET_E r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD E, C
@-------------------------------------------------------------------------------
op59:

	READ_C r6
	SET_E r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD E, D
@-------------------------------------------------------------------------------
op5A:

	READ_D r6
	SET_E r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD E, E
@-------------------------------------------------------------------------------
op5B:

	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD E, H
@-------------------------------------------------------------------------------
op5C:

	READ_H r6
	SET_E r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD E, L
@-------------------------------------------------------------------------------
op5D:

	READ_L r6
	SET_E r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD E, (HL)
@-------------------------------------------------------------------------------
op5E:

	READ_HL r7
	READ_8 r6, r7
	SET_E r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD H, B
@-------------------------------------------------------------------------------
op60:

	READ_B r6
	SET_H r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD H, C
@-------------------------------------------------------------------------------
op61:

	READ_C r6
	SET_H r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD H, D
@-------------------------------------------------------------------------------
op62:

	READ_D r6
	SET_H r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD H, E
@-------------------------------------------------------------------------------
op63:

	READ_E r6
	SET_H r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD H, H
@-------------------------------------------------------------------------------
op64:

	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD H, L
@-------------------------------------------------------------------------------
op65:

	READ_L r6
	SET_H r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD H, (HL)
@-------------------------------------------------------------------------------
op66:

	READ_HL r7
	READ_8 r6, r7
	SET_H r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD L, B
@-------------------------------------------------------------------------------
op68:

	READ_B r6
	SET_L r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD L, C
@-------------------------------------------------------------------------------
op69:

	READ_C r6
	SET_L r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD L, D
@-------------------------------------------------------------------------------
op6A:

	READ_D r6
	SET_L r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD L, E
@-------------------------------------------------------------------------------
op6B:

	READ_E r6
	SET_L r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD L, H
@-------------------------------------------------------------------------------
op6C:

	READ_H r6
	SET_L r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD L, L
@-------------------------------------------------------------------------------
op6D:

	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD L, (HL)
@-------------------------------------------------------------------------------
op6E:

	READ_HL r7
	READ_8 r6, r7
	SET_L r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL), B
@-------------------------------------------------------------------------------
op70:
	
	READ_B r6
	READ_HL r7
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL), C
@-------------------------------------------------------------------------------
op71:
	
	READ_C r6
	READ_HL r7
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL), D
@-------------------------------------------------------------------------------
op72:
	
	READ_D r6
	READ_HL r7
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL), E
@-------------------------------------------------------------------------------
op73:
	
	READ_E r6
	READ_HL r7
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL), H
@-------------------------------------------------------------------------------
op74:
	
	READ_H r6
	READ_HL r7
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL), L
@-------------------------------------------------------------------------------
op75:
	
	READ_L r6
	READ_HL r7
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL), XX
@-------------------------------------------------------------------------------
op36:
	
	READ_IMM8 r6
	READ_HL r7
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ LD A, (BC)
@-------------------------------------------------------------------------------
op0A:
	
	READ_BC r6
	READ_8 r6, r6
	SET_A r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD A, (DE)
@-------------------------------------------------------------------------------
op1A:
	
	READ_DE r6
	READ_8 r6, r6
	SET_A r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD A, (XXXX)
@-------------------------------------------------------------------------------
opFA:
	
	READ_IMM16 r6, r7
	READ_8 r6, r6
	SET_A r6
	UPDATE_CYCLE_COUNT 4
	bx lr

@-------------------------------------------------------------------------------
@ LD A, XX
@-------------------------------------------------------------------------------
op3E:
	
	READ_IMM8 r6
	SET_A r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD B, A
@-------------------------------------------------------------------------------
op47:
	
	READ_A r6
	SET_B r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@###############################################################################
	.ltorg
@###############################################################################

@-------------------------------------------------------------------------------
@ LD C, A
@-------------------------------------------------------------------------------
op4F:
	
	READ_A r6
	SET_C r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD D, A
@-------------------------------------------------------------------------------
op57:
	
	READ_A r6
	SET_D r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD E, A
@-------------------------------------------------------------------------------
op5F:
	
	READ_A r6
	SET_E r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD H, A
@-------------------------------------------------------------------------------
op67:
	
	READ_A r6
	SET_H r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD L, A
@-------------------------------------------------------------------------------
op6F:
	
	READ_A r6
	SET_L r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ LD (BC), A
@-------------------------------------------------------------------------------
op02:
	
	READ_A r6
	READ_BC r7
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (DE), A
@-------------------------------------------------------------------------------
op12:
	
	READ_A r6
	READ_DE r7
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL), A
@-------------------------------------------------------------------------------
op77:
	
	READ_A r6
	READ_HL r7
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL), A
@-------------------------------------------------------------------------------
opEA:
	
	READ_IMM16 r7, r6
	READ_A r6
	WRITE_8 r6, r7
	UPDATE_CYCLE_COUNT 4
	bx lr

@-------------------------------------------------------------------------------
@ LD A, (FF00 + C)
@-------------------------------------------------------------------------------
opF2:
	
	READ_C r6
	add r6, r6, r11, lsl #8
	READ_8 r7, r6
	SET_A r7
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (FF00 + C), A
@-------------------------------------------------------------------------------
opE2:
	
	READ_C r6
	add r6, r6, r11, lsl #8
	READ_A r7
	WRITE_8 r7, r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD A, (HL-)
@-------------------------------------------------------------------------------
op3A:
	
	READ_HL r6
	READ_8 r7, r6
	SET_A r7
	sub r6, r6, #1
	SET_HL r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL-), A
@-------------------------------------------------------------------------------
op32:
	
	READ_HL r6
	READ_A r7
	WRITE_8 r7, r6
	sub r6, r6, #1
	SET_HL r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD A, (HL+)
@-------------------------------------------------------------------------------
op2A:
	
	READ_HL r6
	READ_8 r7, r6
	SET_A r7
	add r6, r6, #1
	SET_HL r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (HL+), A
@-------------------------------------------------------------------------------
op22:
	
	READ_HL r6
	READ_A r7
	WRITE_8 r7, r6
	add r6, r6, #1
	SET_HL r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD (FF00 + XX), A
@-------------------------------------------------------------------------------
opE0:
	
	READ_IMM8 r6
	add r6, r6, r11, lsl #8
	READ_A r7
	WRITE_8 r7, r6
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ LD A, (FF00 + XX)
@-------------------------------------------------------------------------------
opF0:
	
	READ_IMM8 r6
	add r6, r6, r11, lsl #8
	READ_8 r7, r6
	SET_A r7
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ LD BC, XXXX
@-------------------------------------------------------------------------------
op01:
	
	READ_IMM16 r6, r7
	SET_BC r6
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ LD DE, XXXX
@-------------------------------------------------------------------------------
op11:
	
	READ_IMM16 r6, r7
	SET_DE r6
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ LD HL, XXXX
@-------------------------------------------------------------------------------
op21:
	
	READ_IMM16 r6, r7
	SET_HL r6
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ LD SP, XXXX
@-------------------------------------------------------------------------------
op31:
	
	READ_IMM16 r6, r7
	SET_SP r6
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ LD SP, HL
@-------------------------------------------------------------------------------
opF9:
	
	READ_HL r6
	SET_SP r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ LD HL, SP+XX
@-------------------------------------------------------------------------------
opF8:
	
	READ_SP r6
	READ_IMM8 r7
	SIGN_EXTEND_8TO17 r7
	RESET_FLAG_Z
	RESET_FLAG_N
	and r8, r6, r11				@FLAG_H
	and r9, r7, r11
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x100
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x10000
	and r6, r6, r12
	SET_HL r6
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ LD (XXXX), SP
@-------------------------------------------------------------------------------
op08:
	
	READ_SP r6
	READ_IMM16 r7, r8
	WRITE_16 r6, r7
	UPDATE_CYCLE_COUNT 5
	bx lr

@-------------------------------------------------------------------------------
@ PUSH AF
@-------------------------------------------------------------------------------
opF5:
	
	READ_AF r6
	READ_SP r7
	WRITE_16 r6, r7
	sub r7, r7, #2
	SET_SP r7
	UPDATE_CYCLE_COUNT 4
	bx lr

@-------------------------------------------------------------------------------
@ PUSH BC
@-------------------------------------------------------------------------------
opC5:
	
	READ_BC r6
	READ_SP r7
	WRITE_16 r6, r7
	sub r7, r7, #2
	SET_SP r7
	UPDATE_CYCLE_COUNT 4
	bx lr

@-------------------------------------------------------------------------------
@ PUSH DE
@-------------------------------------------------------------------------------
opD5:
	
	READ_DE r6
	READ_SP r7
	WRITE_16 r6, r7
	sub r7, r7, #2
	SET_SP r7
	UPDATE_CYCLE_COUNT 4
	bx lr

@-------------------------------------------------------------------------------
@ PUSH HL
@-------------------------------------------------------------------------------
opE5:
	
	READ_HL r6
	READ_SP r7
	WRITE_16 r6, r7
	sub r7, r7, #2
	SET_SP r7
	UPDATE_CYCLE_COUNT 4
	bx lr

@-------------------------------------------------------------------------------
@ POP AF
@-------------------------------------------------------------------------------
opF1:
	
	READ_SP r6
	READ_16 r7, r6, r8
	SET_AF r7
	add r6, r6, #2
	SET_SP r6
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ POP BC
@-------------------------------------------------------------------------------
opC1:
	
	READ_SP r6
	READ_16 r7, r6, r8
	SET_BC r7
	add r6, r6, #2
	SET_SP r6
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ POP DE
@-------------------------------------------------------------------------------
opD1:
	
	READ_SP r6
	READ_16 r7, r6, r8
	SET_DE r7
	add r6, r6, #2
	SET_SP r6
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ POP HL
@-------------------------------------------------------------------------------
opE1:
	
	READ_SP r6
	READ_16 r7, r6, r8
	SET_HL r7
	add r6, r6, #2
	SET_SP r6
	UPDATE_CYCLE_COUNT 3
	bx lr

@-------------------------------------------------------------------------------
@ ADD A, A
@-------------------------------------------------------------------------------
op87:
	
	READ_A r6
	RESET_FLAG_N
	and r7, r6, #0xF			@FLAG_H
	and r8, r6, #0xF
	add r7, r7, r8
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r6
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADD A, B
@-------------------------------------------------------------------------------
op80:
	
	READ_A r6
	READ_B r7
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADD A, C
@-------------------------------------------------------------------------------
op81:
	
	READ_A r6
	READ_C r7
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADD A, D
@-------------------------------------------------------------------------------
op82:
	
	READ_A r6
	READ_D r7
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADD A, E
@-------------------------------------------------------------------------------
op83:
	
	READ_A r6
	READ_E r7
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADD A, H
@-------------------------------------------------------------------------------
op84:
	
	READ_A r6
	READ_H r7
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADD A, L
@-------------------------------------------------------------------------------
op85:
	
	READ_A r6
	READ_L r7
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADD A, (HL)
@-------------------------------------------------------------------------------
op86:
	
	READ_A r6
	READ_HL r7
	READ_8 r7, r7
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ ADD A, XX
@-------------------------------------------------------------------------------
opC6:
	
	READ_A r6
	READ_IMM8 r7
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADC A, A
@-------------------------------------------------------------------------------
op8F:
	
	READ_A r6
	add r7, r6, #1
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r6
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADC A, B
@-------------------------------------------------------------------------------
op88:
	
	READ_A r6
	READ_B r7
	add r7, r7, #1
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADC A, C
@-------------------------------------------------------------------------------
op89:
	
	READ_A r6
	READ_C r7
	add r7, r7, #1
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADC A, D
@-------------------------------------------------------------------------------
op8A:
	
	READ_A r6
	READ_D r7
	add r7, r7, #1
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADC A, E
@-------------------------------------------------------------------------------
op8B:
	
	READ_A r6
	READ_E r7
	add r7, r7, #1
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADC A, H
@-------------------------------------------------------------------------------
op8C:
	
	READ_A r6
	READ_H r7
	add r7, r7, #1
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADC A, L
@-------------------------------------------------------------------------------
op8D:
	
	READ_A r6
	READ_L r7
	add r7, r7, #1
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr

@-------------------------------------------------------------------------------
@ ADC A, (HL)
@-------------------------------------------------------------------------------
op8E:
	
	READ_A r6
	READ_HL r7
	add r7, r7, #1
	READ_8 r7, r7
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 2
	bx lr

@-------------------------------------------------------------------------------
@ ADC A, XX
@-------------------------------------------------------------------------------
opCE:
	
	READ_A r6
	READ_IMM8 r7
	add r7, r7, #1
	RESET_FLAG_N
	and r8, r6, #0xF			@FLAG_H
	and r9, r7, #0xF
	add r8, r8, r9
	UPDATE_FLAG_H r8, #0x10
	add r6, r6, r7
	UPDATE_FLAG_C r6, #0x100
	ands r6, r6, r11
	UPDATE_FLAG_Z
	SET_A r6
	UPDATE_CYCLE_COUNT 1
	bx lr




@@@@@@@@@@@@@
	.data
@@@@@@@@@@@@@

@-------------------------------------------------------------------------------
@ Gameboy Processor State
@-------------------------------------------------------------------------------
State:
	.global State

    .word 0x00000000	@ A,B,C,F
    .word 0x00000000	@ D,E,H,L
    .word 0x0000FFFE	@ SP
    .word 0x00000100	@ PC (initially set to 0x100)
    .word 0x00000000	@ Frame cycle count (overflow from last frame)

@-------------------------------------------------------------------------------
@ Opcode Function Jump Table
@-------------------------------------------------------------------------------
OpcodeJT:

    .word op00, op01, op02, op__, op__, op__, op06, op__, op08, op__, op0A, op__, op__, op__, op0E, op__
    .word op__, op11, op12, op__, op__, op__, op16, op__, op__, op__, op1A, op__, op__, op__, op1E, op__
    .word op__, op21, op22, op__, op__, op__, op26, op__, op__, op__, op2A, op__, op__, op__, op2E, op__
    .word op__, op31, op32, op__, op__, op__, op36, op__, op__, op__, op3A, op__, op__, op__, op3E, op__
    .word op40, op41, op42, op43, op44, op45, op46, op47, op48, op49, op4A, op4B, op4C, op4D, op4E, op4F
    .word op50, op51, op52, op53, op54, op55, op56, op57, op58, op59, op5A, op5B, op5C, op5D, op5E, op5F
    .word op60, op61, op62, op63, op64, op65, op66, op67, op68, op69, op6A, op6B, op6C, op6D, op6E, op6F
    .word op70, op71, op72, op73, op74, op75, op__, op77, op78, op79, op7A, op7B, op7C, op7D, op7E, op7F
    .word op80, op81, op82, op86, op84, op85, op86, op87, op88, op89, op8A, op8B, op8C, op8D, op8E, op8F
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, opC1, op__, op__, op__, opC5, opC6, op__, op__, op__, op__, op__, op__, op__, opCE, op__
    .word op__, opD1, op__, op__, op__, opD5, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word opE0, opE1, opE2, op__, op__, opE5, op__, op__, op__, op__, opEA, op__, op__, op__, op__, op__
    .word opF0, opF1, opF2, op__, op__, opF5, op__, op__, opF8, opF9, opFA, op__, op__, op__, op__, op__

@-------------------------------------------------------------------------------
@ CB Opcode Function Jump Table
@-------------------------------------------------------------------------------
CBOpcodeJT:

    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__
    .word op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__, op__